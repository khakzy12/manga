<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MangaHub Pro - Distributed System Demo</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; background: #eef2f3; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        
        /* Chat Styling */
        #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #fafafa; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; padding: 5px 10px; border-radius: 5px; background: #fff; border-left: 4px solid #3498db; }
        .msg b { color: #2980b9; }

        /* Form Styling */
        input { width: calc(100% - 22px); padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }
        .hidden { display: none; }
        #status-bar { grid-column: span 2; padding: 10px; background: #2c3e50; color: white; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="status-bar">Status: Not Authenticated | <span id="user-display">Guest</span></div>

    <div class="sidebar">
        <div class="card" id="auth-card">
            <h2>üîê Authentication</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <p style="font-size: 0.8em; text-align: center;">Don't have an account? <a href="#" onclick="register()">Register</a></p>
        </div>

        <div class="card" id="admin-card">
            <h2>üõ†Ô∏è Admin Trigger (UDP)</h2>
            <p style="font-size: 0.8em;">Requires Header: X-User-Role: admin</p>
            <input type="text" id="new-manga-title" placeholder="Manga Title">
            <button style="background: #e74c3c;" onclick="adminAddManga()">Add & Broadcast</button>
        </div>
    </div>

    <div class="main-content">
        <div class="card">
            <h2>üîç Manga Search (gRPC via HTTP)</h2>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="search-query" placeholder="Search title (e.g., piece)">
                <button style="width: 100px;" onclick="searchManga()">Search</button>
            </div>
            <div id="search-results" style="margin-top: 15px;"></div>
        </div>

        <div class="card">
            <h2>üí¨ Live Chat (WebSockets)</h2>
            <div id="chat-box"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button style="width: 100px;" onclick="sendChatMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let TOKEN = "";
        let socket;

        // --- AUTH LOGIC ---
    async function login() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;

    try {
        const res = await fetch('http://localhost:8080/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, // Added header
            body: JSON.stringify({ username: user, password: pass })
        });

        const data = await res.json();

        if (data.token) {
            TOKEN = data.token; // 1. Save the token first
            
            // 2. NOW decode it to check for the admin role
            const payload = JSON.parse(atob(TOKEN.split('.')[1])); 
            console.log("User Role:", payload.role);

            if (payload.role === 'admin') {
                document.getElementById('admin-card').classList.remove('hidden');
            } else {
                document.getElementById('admin-card').classList.add('hidden');
            }

            // 3. Update UI and connect WebSocket
            document.getElementById('status-bar').innerText = `Status: Logged In | User: ${user}`;
            document.getElementById('auth-card').classList.add('hidden');
            initWebSocket(); 
        } else { 
            alert("Login Failed: " + (data.error || "Invalid credentials")); 
        }
    } catch (e) { 
        console.error(e);
        alert("Server Offline or Request Failed"); 
    }
}

    async function register() {
    // 1. Get values from the inputs
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;
    
    // 2. Add validation so you don't send empty strings
    if (!user || !pass) {
        alert("Please enter both username and password");
        return;
    }

    try {
        const res = await fetch('http://localhost:8080/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // FIX: Use 'user' and 'pass' which you defined above
            body: JSON.stringify({ username: user, password: pass }) 
        });

        if (res.ok) {
            alert("‚úÖ Registered! Now click Login.");
        } else {
            const data = await res.json();
            alert("‚ùå Registration failed: " + (data.error || "User might exist"));
        }
    } catch (e) {
        alert("Server Offline");
    }
}

        // --- WEBSOCKET LOGIC (With Authentication) ---
    function initWebSocket() {
            // Passing token via sub-protocol or query param is common for WS
            // Since your Gin middleware looks at Authorization header, 
            // we use a ticket-based approach or a query param if your middleware supports it.
            // FOR THIS DEMO: We will use the native WebSocket with the token in the URL
        socket = new WebSocket(`ws://localhost:8080/ws/chat?token=${TOKEN}`);

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const box = document.getElementById('chat-box');
            let finalHtml = ""; // Use one variable to hold the HTML

        if (data.username === "SYSTEM-BROADCAST") {
            finalHtml = `
                <div class="msg" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 5px 0;">
                    <b style="color: #856404;">üì¢ SYSTEM:</b> ${data.message}
                </div>`;
        } else {
        const name = data.username ? data.username : "Unknown";
        finalHtml = `<div class="msg" style="margin: 5px 0;"><b>${name}:</b> ${data.message}</div>`;
    }

    // Add to the box once
    box.insertAdjacentHTML('beforeend', finalHtml);
    box.scrollTop = box.scrollHeight;
};

            socket.onopen = () => console.log("Chat Connected");
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            socket.send(JSON.stringify({ message: input.value }));
            input.value = "";
        }

        // --- SEARCH LOGIC (gRPC) ---
        async function searchManga() {
            const q = document.getElementById('search-query').value;
            const res = await fetch(`http://localhost:8080/manga/${q}`);
            const data = await res.json();
            const container = document.getElementById('search-results');
            
            if (res.ok) {
                container.innerHTML = `
                    <div style="padding: 10px; background: #f9f9f9; border-radius: 5px;">
                        <strong>${data.title}</strong><br>
                        <small>Author: ${data.author} | Status: ${data.status}</small>
                        <p>${data.description}</p>
                    </div>`;
            } else {
                container.innerHTML = `<p style="color:red">Not found</p>`;
            }
        }

        // --- ADMIN TRIGGER (UDP) ---
        // async function adminAddManga() {
        //     const title = document.getElementById('new-manga-title').value;
        //     const res = await fetch('http://localhost:8080/admin/add-manga', {
        //         method: 'POST',
        //         headers: { 
        //             'X-User-Role': 'admin',
        //             'Content-Type': 'application/json' 
        //         },
        //         body: JSON.stringify({ title: title })
        //     });
        //     const data = await res.json();
        //     alert(data.message);
        // }
    </script>
</body>
</html>